name: AI Tools Release Watcher

on:
  schedule:
    # 12æ™‚é–“ã”ã¨ã«ãƒã‚§ãƒƒã‚¯ (æ—¥æœ¬æ™‚é–“ 9:00, 21:00 ã”ã‚)
    - cron: '0 */12 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º

permissions:
  contents: write

jobs:
  check-and-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check for Updates
        id: check
        run: |
          # ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿
          if [ -f versions.json ]; then
            OLD_CLAUDE=$(jq -r '.claude_code' versions.json)
            OLD_ANTI=$(jq -r '.antigravity' versions.json)
          else
            OLD_CLAUDE="v0.0.0"
            OLD_ANTI="v0.0.0"
          fi

          echo "Current stored versions: Claude=$OLD_CLAUDE, Antigravity=$OLD_ANTI"

          # 1. Claude Code ã®æœ€æ–°å–å¾— (npm)
          # GitHub Releasesã‚ˆã‚Šnpmã®æ–¹ãŒç¢ºå®Ÿãªå ´åˆãŒã‚ã‚‹ãŸã‚npmã‚’å‚ç…§
          NEW_CLAUDE_VER=$(npm view @anthropic-ai/claude-code version)
          NEW_CLAUDE="v$NEW_CLAUDE_VER"

          # 2. Antigravity ã®æœ€æ–°å–å¾— (GitHub)
          # Google DeepMindã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ä»®å®šã€‚å­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
          HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}" https://api.github.com/repos/google-deepmind/antigravity/releases/latest)
          if [ "$HTTP_CODE" == "200" ]; then
            NEW_ANTI=$(curl -s https://api.github.com/repos/google-deepmind/antigravity/releases/latest | jq -r '.tag_name')
          else
            NEW_ANTI="$OLD_ANTI" # è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æ›´æ–°ãªã—ã¨ã™ã‚‹
          fi

          echo "Latest versions found: Claude=$NEW_CLAUDE, Antigravity=$NEW_ANTI"

          # æ›´æ–°åˆ¤å®šã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
          MESSAGE=""
          UPDATED="false"

          if [ "$NEW_CLAUDE" != "$OLD_CLAUDE" ] && [ "$NEW_CLAUDE" != "v" ]; then
            MESSAGE="${MESSAGE}ğŸš€ **Claude Code Updated!**\n\`$OLD_CLAUDE\` -> \`$NEW_CLAUDE\`\nCheck: https://www.npmjs.com/package/@anthropic-ai/claude-code\n\n"
            UPDATED="true"
            # JSONæ›´æ–°
            tmp=$(mktemp)
            jq --arg v "$NEW_CLAUDE" '.claude_code = $v' versions.json > "$tmp" && mv "$tmp" versions.json
          fi

          if [ "$NEW_ANTI" != "$OLD_ANTI" ] && [ "$NEW_ANTI" != "" ]; then
            MESSAGE="${MESSAGE}ğŸŒŒ **Antigravity Updated!**\n\`$OLD_ANTI\` -> \`$NEW_ANTI\`\nCheck: https://github.com/google-deepmind/antigravity\n\n"
            UPDATED="true"
             # JSONæ›´æ–°
            tmp=$(mktemp)
            jq --arg v "$NEW_ANTI" '.antigravity = $v' versions.json > "$tmp" && mv "$tmp" versions.json
          fi

          echo "updated=$UPDATED" >> $GITHUB_OUTPUT
          
          # Discordç”¨ã«æ”¹è¡Œã‚³ãƒ¼ãƒ‰ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦ç’°å¢ƒå¤‰æ•°ã«å…¥ã‚Œã‚‹
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "DISCORD_MESSAGE<<$EOF" >> $GITHUB_ENV
          echo -e "$MESSAGE" >> $GITHUB_ENV
          echo "$EOF" >> $GITHUB_ENV

      - name: Commit and Push changes
        if: steps.check.outputs.updated == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Release Watcher Bot"
          git add versions.json
          git commit -m "Update versions.json"
          git push

      - name: Notify Discord
        if: steps.check.outputs.updated == 'true'
        run: |
          # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å®‰å…¨ã«JSONã«å¤‰æ›
          JSON_PAYLOAD=$(jq -n --arg content "$DISCORD_MESSAGE" '{content: $content}')
          
          curl -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            "https://discord.com/api/webhooks/1460797206918594645/EjWk267W8lwvpQfngr9lBYxjSxL5cmIz5Se-ywXDefg5m8vF8F5dlmC1O77_kiWNcn7m"
