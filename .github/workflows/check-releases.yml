name: AI Tools Release Watcher

on:
  schedule:
    # 12ÊôÇÈñì„Åî„Å®„Å´„ÉÅ„Çß„ÉÉ„ÇØ (Êó•Êú¨ÊôÇÈñì 9:00, 21:00 „Åî„Çç)
    - cron: '0 */12 * * *'
  workflow_dispatch: # ÊâãÂãïÂÆüË°å„Éú„Çø„É≥„ÇíË°®Á§∫

permissions:
  contents: write

jobs:
  check-and-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check for Updates
        id: check
        run: |
          # ‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Çã„Éê„Éº„Ç∏„Éß„É≥„ÇíË™≠„ÅøËæº„Åø
          if [ -f versions.json ]; then
            OLD_CLAUDE=$(jq -r '.claude_code' versions.json)
            OLD_ANTI=$(jq -r '.antigravity' versions.json)
          else
            OLD_CLAUDE="v0.0.0"
            OLD_ANTI="v0.0.0"
          fi

          echo "Current stored versions: Claude=$OLD_CLAUDE, Antigravity=$OLD_ANTI"

          # 1. Claude Code „ÅÆÊúÄÊñ∞ÂèñÂæó (npm)
          # GitHub Releases„Çà„Çänpm„ÅÆÊñπ„ÅåÁ¢∫ÂÆü„Å™Â†¥Âêà„Åå„ÅÇ„Çã„Åü„ÇÅnpm„ÇíÂèÇÁÖß
          NEW_CLAUDE_VER=$(npm view @anthropic-ai/claude-code version)
          NEW_CLAUDE="v$NEW_CLAUDE_VER"

          # 2. Antigravity „ÅÆÊúÄÊñ∞ÂèñÂæó (GitHub)
          # Google DeepMind„ÅÆ„É™„Éù„Ç∏„Éà„É™„Çí‰ªÆÂÆö„ÄÇÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
          HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}" https://api.github.com/repos/google-deepmind/antigravity/releases/latest)
          if [ "$HTTP_CODE" == "200" ]; then
            NEW_ANTI=$(curl -s https://api.github.com/repos/google-deepmind/antigravity/releases/latest | jq -r '.tag_name')
          else
            NEW_ANTI="$OLD_ANTI" # Ë¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØÊõ¥Êñ∞„Å™„Åó„Å®„Åô„Çã
          fi

          echo "Latest versions found: Claude=$NEW_CLAUDE, Antigravity=$NEW_ANTI"

          # Êõ¥Êñ∞Âà§ÂÆö„Å®„É°„ÉÉ„Çª„Éº„Ç∏‰ΩúÊàê
          MESSAGE=""
          UPDATED="false"

          if [ "$NEW_CLAUDE" != "$OLD_CLAUDE" ] && [ "$NEW_CLAUDE" != "v" ]; then
            MESSAGE="${MESSAGE}üöÄ **Claude Code Updated!**\n\`$OLD_CLAUDE\` -> \`$NEW_CLAUDE\`\nCheck: https://www.npmjs.com/package/@anthropic-ai/claude-code\n\n"
            UPDATED="true"
            # JSONÊõ¥Êñ∞
            tmp=$(mktemp)
            jq --arg v "$NEW_CLAUDE" '.claude_code = $v' versions.json > "$tmp" && mv "$tmp" versions.json
          fi

          if [ "$NEW_ANTI" != "$OLD_ANTI" ] && [ "$NEW_ANTI" != "" ]; then
            MESSAGE="${MESSAGE}üåå **Antigravity Updated!**\n\`$OLD_ANTI\` -> \`$NEW_ANTI\`\nCheck: https://github.com/google-deepmind/antigravity\n\n"
            UPDATED="true"
             # JSONÊõ¥Êñ∞
            tmp=$(mktemp)
            jq --arg v "$NEW_ANTI" '.antigravity = $v' versions.json > "$tmp" && mv "$tmp" versions.json
          fi

          echo "updated=$UPDATED" >> $GITHUB_OUTPUT
          
          # DiscordÁî®„Å´ÊîπË°å„Ç≥„Éº„Éâ„Çí„Ç®„Çπ„Ç±„Éº„Éó„Åó„Å¶Áí∞Â¢ÉÂ§âÊï∞„Å´ÂÖ•„Çå„Çã
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "DISCORD_MESSAGE<<$EOF" >> $GITHUB_ENV
          echo -e "$MESSAGE" >> $GITHUB_ENV
          echo "$EOF" >> $GITHUB_ENV

      - name: Commit and Push changes
        if: steps.check.outputs.updated == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Release Watcher Bot"
          git add versions.json
          git commit -m "Update versions.json"
          git push

      - name: Notify Discord
        if: steps.check.outputs.updated == 'true'
        run: |
          curl -H "Content-Type: application/json" \
            -d "{\"content\": \"${DISCORD_MESSAGE}\"}" \
            "https://discord.com/api/webhooks/1460797206918594645/EjWk267W8lwvpQfngr9lBYxjSxL5cmIz5Se-ywXDefg5m8vF8F5dlmC1O77_kiWNcn7m"
